# Prevent access to .htaccess
<Files ~ "^.*\.([Hh][Tt][Aa]|[Pp][Yy])">
    Require all denied
</Files>

# Redirecting HTTP traffic to HTTPS. (Keep commented on localhost !)
# This is handled by other services, but it should still be enabled in production just to be safe.
#RewriteEngine On
#RewriteCond %{SERVER_PORT} 80
#RewriteRule ^(.*)$ https://nibblepoker.lu/$1 [R,L]

# Correcting some default options for security and language/content redirection.
# FollowSymlinks is also on since it's required for "mod_rewrite" and the server is jailed.
Options -Indexes +FollowSymlinks -ExecCGI
ServerSignature Off

# Custom error pages.
#ErrorDocument 403 /403.php
#ErrorDocument 404 /404.php

# Setting up browser's caching rules
# See:
#  * https://stackoverflow.com/a/13029007
#  * https://www.a2hosting.com/kb/developer-corner/apache-web-server/turning-off-caching-using-htaccess

# Default: 12 hours
Header set Cache-Control "max-age=43200, public, must-revalidate"

<FilesMatch "\.(?i:gif|jpe?g|png|ico|svg|woff2|otf|json)$">
    # Static files: 1 Week
    Header set Cache-Control "max-age=604800, public, must-revalidate"
</FilesMatch>

###<FilesMatch "\.(?i:css|js)$">
###    # Semi-static files: 1 Day
###    Header set Cache-Control "max-age=86400, public, must-revalidate"
###</FilesMatch>

<FilesMatch "\.(?i:gif|jpe?g|png|ico|svg|woff2|otf|json)$">
    # Versioning files: Never
    Header set Cache-Control "no-cache"
</FilesMatch>

#Header set Pragma "no-cache"
#Header set Expires 0

# Setting some headers for security.
# > These headers will very likely prevent you from running ads on the page which is a good thing.
# > Firstly, fuck ads and the people shilling them.
# > Secondly, you don't need ads to pay for the tiny amount of bandwidth this app requires.
# > CDNs exist for a reason and unless you are a cheapskate you can easily pay for it by not pissing money for a
#     second on useless services and goods.
# > Finally, I won't run ads or trackers so it's all good on my side.
# > If you want to run some, I'll let you fuck over your user's security and fight the CSP header's src rules on
#     your own.
Header always set X-Frame-Options "deny"
#Header always set Content-Security-Policy "default-src 'self' files.nibblepoker.lu; object-src 'none'; child-src 'self'; frame-ancestors 'none'; upgrade-insecure-requests; block-all-mixed-content"
Header always set X-XSS-Protection " 1; mode=block"
Header always set Referrer-Policy "no-referrer"
Header always set X-Content-Type-Options "nosniff"
#Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
##Header always set Cache-Control "max-age=300, public"
#Header always set Access-Control-Allow-Origin "*"

# Removing some useless headers.
# > Apache may not remove them all because reasons...
Header unset X-Powered-By
Header unset Server
Header unset Last-Modified
Header unset Date
Header unset ETag

# Handling all other redirections.
RewriteEngine On

# Languages. (Does not work with a regex)
#RewriteRule ^en/(.*)$ /$1 [QSA]
#RewriteRule ^fr/(.*)$ /$1 [QSA]
#RewriteRule ^lb/(.*)$ /$1 [QSA]

# Honeypots. (Just to fuck with automated scanners, gotta love those unsolicited emails tho...)

# Sending a 404 for git and IDEs folders just in case they ever get copied to the web server,
#  or if one of the honeypot files is acessed directly.
# A 404 is preferred to prevent further scanning of this folder and from raising some flags.
# FIXME: These rules break the later honeypot rules !!!
#RedirectMatch 404 ^.*\.?(git|vs(code)|idea).*
#RedirectMatch 404 ^.*honeypot.*

# Internal redirections for scanning and exploit attempts.
# These rules are here since they're easier to implement in the .htaccess.
#RewriteRule ^.*(install|xmlrpc)\.php.*$ /honeypot/file-php.php [QSA]
#RewriteRule ^.*\.xml.*$ /honeypot/file-xml.php [QSA]
#RewriteRule ^.*wlwmanifest\.xml.*$ /honeypot/file-xml-wlwmanifest.php [QSA]
#RewriteRule ^.*\.env.*$ /honeypot/file-env.php [QSA]
#RewriteRule ^.*(ap(i|p.*)|cms|sit[eo]|shop.*|wp.*).*$ /honeypot/folder.php [QSA]

# Cases left to handle:
# * /wp-admin/post.php?id=whatever
# * /public /vendor /storage
# * //vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php

# TODO: Implement bee-movie themed tarpit once I have a rate-limiting solution in place !
